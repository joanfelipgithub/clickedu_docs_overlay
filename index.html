<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clickedu ‚Äì bookmarklet per la finestra de Documents</title>
<style>
body { font-family: Arial, sans-serif; margin: 2rem; background: #f5f5f5; color: #333; line-height: 1.6; }
.container { max-width: 720px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.bookmarklet { display: inline-block; background: #ff6b35; color: #fff; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: bold; margin-top: 1rem; cursor: move; font-size: 16px; box-shadow: 0 2px 8px rgba(255,107,53,0.3); transition: all 0.2s; }
.bookmarklet:hover { background: #e55a28; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,107,53,0.4); }
#copyBox { width: 100%; padding: 0.8rem; font-size: 0.85rem; margin-top: 0.5rem; box-sizing: border-box; border: 2px solid #ddd; border-radius: 4px; font-family: monospace; background: #f9f9f9; }
#copyBtn { margin-top: 0.5rem; padding: 8px 16px; background: #28a745; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
#copyBtn:hover { background: #218838; }
.instruction { background: #e3f2fd; padding: 1rem; border-left: 4px solid #2196f3; margin: 1rem 0; border-radius: 4px; }
hr { margin: 2rem 0; border: none; border-top: 2px solid #eee; }
</style>
</head>
<body>
<div class="container">
<h1>üìÇ Clickedu ‚Äì Finestra de documents</h1>

<div class="instruction">
<p><strong>1Ô∏è‚É£ Arrossega el bot√≥ taronja de sota a la barra de marcadors del teu navegador</strong></p>
<p>Aix√≤ desa un bookmarklet que s'executar√† a Clickedu per mostrar els teus documents en una finestra molt pr√†ctica.</p>
</div>

<div style="text-align: center; padding: 20px; background: #fafafa; border-radius: 8px; margin: 1rem 0;">
<a class="bookmarklet" id="bookmarkletLink" href="#">üìÇ Docs Clickedu</a>
<p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">‚¨ÜÔ∏è Arrossega aquest bot√≥ a la barra de marcadors</p>
</div>

<div class="instruction">
<p><strong>2Ô∏è‚É£ Alternativa: Copia al porta-retalls</strong></p>
<p>Si arrossegar no funciona (m√≤bil o restriccions del navegador), fes clic al bot√≥ Copia de sota, despr√©s crea un marcador nou manualment i enganxa l'URL.</p>
</div>

<textarea id="copyBox" rows="4" readonly></textarea>
<button id="copyBtn">üìã Copia al porta-retalls</button>

<hr>
<p style="font-size: 0.9rem; color: #666;">
<strong>‚ÑπÔ∏è Com funciona:</strong> Aquesta versi√≥ carrega la llista de documents autom√†ticament des del Full de C√†lcul de Google amb colors per grups i text contrastat.
</p>
</div>

<script>
const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1iAF3p81G8DdByShDyfz4ShoweV80QWuoQ7wWSzZUORQ/export?format=csv&gid=0';
const PROXY_URL = 'https://cors-anywhere.herokuapp.com/';
const FINAL_FETCH_URL = PROXY_URL + GOOGLE_SHEET_URL;

/* ------------------- helper functions ------------------- */
function getTextColor(bgColor){
    // Determines if text should be black or white based on HSL lightness (L)
    const m = bgColor.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
    if(!m) return '#fff';
    return (+m[3]) > 55 ? '#000' : '#fff';
}

function generateGroupColors(groups){
    // Generates distinct HSL colors based on the number of groups
    const map = {};
    const total = groups.length;
    groups.forEach((g,i)=>{
        const hue = Math.floor((i/total)*360);
        map[g] = { main:`hsl(${hue},70%,50%)`, hover:`hsl(${hue},80%,40%)` };
    });
    return map;
}

/* ----------------- build the bookmarklet code ---------------- */
(async function generateBookmarkletURI(){
    let fetchedColorMap = {};

    try{
        // 1. Fetch CSV to determine groups for color generation
        const resp = await fetch(FINAL_FETCH_URL);
        // Using double quotes and escaping the apostrophe in the error message
        if(!resp.ok) throw new Error("No s\\'ha pogut carregar el full de dades. Codi: "+resp.status); 
        const csv = await resp.text();

        const lines = csv.split('\n').slice(1);
        const groups = Array.from(new Set(
            lines.filter(l=>l.trim())
                 .map(l=>l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)[0].trim())
                 .filter(g=>g)
        ));
        fetchedColorMap = generateGroupColors(groups);
    }catch(e){
        console.error(e);
        // Default color map in case of fetch failure
        fetchedColorMap = { default:{ main:'hsl(210,70%,50%)', hover:'hsl(210,80%,40%)' } };
    }

    const colorMapJSON = JSON.stringify(fetchedColorMap);
    
    // Simplified getTextColor function for injection
    const simplifiedGetTextColor = `function(bgColor){
        const m=bgColor.match(/hsl\\((\\d+),\\s*(\\d+)%,\\s*(\\d+)%\\)/);
        if(!m) return '#fff';
        return (+m[3])>55?'#000':'#fff';
    }`;

    /* ---- raw JavaScript that will run as a bookmarklet ---- */
    const rawBookmarkletJS = `(async function(){
        if(!location.href.includes('insscf.clickedu.eu/sumari/index.php?p=links')){
            // Explicitly escaping the single quote in 'links'
            alert("‚ö†Ô∏è Aquest bookmarklet nom√©s funciona a la p√†gina \\'links\\' de Clickedu."); 
            return;
        }

        const COLOR_MAP=${colorMapJSON};
        const getTextColor=${simplifiedGetTextColor};

        /* hide the original form */
        const form=document.evaluate('//form[@action="https://shorturl.at/anS1H"]',document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;
        const container=form?.closest('.bloc-info-sumari');
        if(container) container.style.display='none'; else if(form) form.style.display='none';

        /* add the toggle button */
        const btn=document.createElement('button');
        btn.textContent='üìÇ Mostrar documents';
        Object.assign(btn.style,{
            position:'fixed',top:'10px',right:'10px',zIndex:9999,
            padding:'10px 15px',background:'#007bff',color:'#fff',
            border:'none',borderRadius:'8px',cursor:'pointer',
            boxShadow:'0 2px 4px rgba(0,0,0,.2)',transition:'background .2s,opacity .3s',
            fontWeight:'bold',opacity:'1'
        });
        btn.onmouseover=()=>btn.style.background='#0056b3';
        btn.onmouseout=()=>btn.style.background='#007bff';
        document.body.appendChild(btn);

        let overlayVisible=false;
        btn.onclick=async function(){
            if(container) container.style.display='none'; else if(form) form.style.display='none';
            if(overlayVisible){closeOverlay();return;}

            overlayVisible=true;
            btn.style.opacity='0.2';

            const overlay=document.createElement('div');
            Object.assign(overlay.style,{
                position:'fixed',top:0,left:0,width:'100%',height:'100%',
                background:'rgba(0,0,0,0.8)',zIndex:9998,
                display:'flex',flexDirection:'column',alignItems:'center',
                justifyContent:'center',padding:'20px',overflowY:'auto'
            });
            overlay.addEventListener('click',e=>{if(e.target===overlay) closeOverlay();});
            document.body.appendChild(overlay);

            const esc=e=>{if(e.key==='Escape') closeOverlay();};
            document.addEventListener('keydown',esc);
            function closeOverlay(){
                overlay.remove();
                document.removeEventListener('keydown',esc);
                overlayVisible=false;
                btn.style.opacity='1';
            }

            const loading=document.createElement('div');
            loading.textContent='‚è≥ Carregant documents...';
            Object.assign(loading.style,{color:'white',fontSize:'18px',marginBottom:'20px'});
            overlay.appendChild(loading);

            try{
                const r=await fetch('${FINAL_FETCH_URL}');
                if(!r.ok) throw new Error("C√†rrega fallida. Codi: "+r.status);
                const csv2=await r.text();
                const rows=csv2.split('\\n').slice(1);
                const docs=rows.filter(l=>l.trim()).map(l=>{
                    const p=l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v=>v.replace(/^"|"$/g,'').trim());
                    if(p.length>=3) return {g:p[0],l:p[1],u:p[2]};
                }).filter(o=>o&&o.g&&o.l&&o.u);

                loading.remove();
                if(docs.length===0){
                    const msg=document.createElement('div');
                    // ESCAPAMENT CORREGIT: s\'han
                    msg.textContent="‚ö†Ô∏è No s\\'han trobat documents v√†lids al full de c√†lcul."; 
                    msg.style.color='#ffc107';
                    overlay.appendChild(msg);
                    return;
                }

                const grid=document.createElement('div');
                Object.assign(grid.style,{
                    display:'grid',
                    gridTemplateColumns:'repeat(auto-fit,minmax(280px,1fr))',
                    gap:'15px',
                    maxWidth:'1200px',
                    width:'100%'
                });

                docs.forEach(d=>{
                    const btn=document.createElement('button');
                    btn.textContent=d.l;
                    const col=COLOR_MAP[d.g]||COLOR_MAP.default;
                    Object.assign(btn.style,{
                        padding:'15px',
                        fontSize:'16px',
                        cursor:'pointer',
                        borderRadius:'12px',
                        border:'none',
                        background:col.main,
                        color:getTextColor(col.main),
                        boxShadow:'0 4px 6px rgba(0,0,0,0.2)',
                        transition:'background .2s'
                    });
                    btn.onmouseover=()=>{btn.style.background=col.hover;btn.style.color=getTextColor(col.hover);};
                    btn.onmouseout=()=>{btn.style.background=col.main;btn.style.color=getTextColor(col.main);};
                    btn.onclick=()=>window.open(d.u,'_blank');
                    grid.appendChild(btn);
                });
                overlay.appendChild(grid);

            }catch(err){
                // ESCAPAMENT CORREGIT: s\'ha
                loading.textContent="‚ùå Error cr√≠tic: No s\\'ha pogut carregar. Detall: "+err.message;
                loading.style.color='#ff6b6b';
            }
        };
    })()`;

    // 2. Minify the JS code to remove unnecessary whitespace/newlines
    const minifiedJS = rawBookmarkletJS.replace(/\s{2,}/g, ' ').replace(/\n/g, ''); 

    // 3. Use the robust encodeURIComponent() to safely encode the entire script
    const finalBookmarkletURI = 'javascript:' + encodeURIComponent(minifiedJS);

    // 4. Update the UI links
    document.getElementById('bookmarkletLink').href = finalBookmarkletURI;
    document.getElementById('copyBox').value = finalBookmarkletURI;
})();

/* -------------------- copy to clipboard logic -------------------- */
document.getElementById('copyBtn').addEventListener('click', function(){
    const ta=document.getElementById('copyBox'); ta.select(); ta.setSelectionRange(0,99999);
    navigator.clipboard.writeText(ta.value).then(()=>{
        const btn=document.getElementById('copyBtn'); btn.textContent='‚úÖ Copiat!'; btn.style.background='#218838';
        setTimeout(()=>{btn.textContent='üìã Copia al porta-retalls'; btn.style.background='#28a745';},2000);
    }).catch(()=>{document.execCommand('copy'); alert('Bookmarklet copiat! Ara crea un marcador nou i enganxa\'l.')});
});
</script>
</body>
</html>
