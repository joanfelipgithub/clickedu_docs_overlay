<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clickedu â€“ V10.1 (execuciÃ³ per clic + bookmarklet)</title>
<style>
/* (estils abreujats, igual que abans) */
body{font-family:Arial,helvetica,sans-serif;margin:2rem;background:#f5f5f5;color:#333}
.container{max-width:720px;margin:auto;background:#fff;padding:2rem;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
.bookmarklet{display:inline-block;background:#ff6b35;color:#fff;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:700;cursor:move}
#copyBox{width:100%;padding:.6rem;font-family:monospace}
#copyBtn{margin-top:.5rem;padding:8px 12px;background:#28a745;color:#fff;border:0;border-radius:4px;cursor:pointer}
</style>
</head>
<body>
<div class="container">
  <h1>\uD83D\uDCC2 Clickedu â€“ V10.1 (Test clic + Bookmarklet)</h1>
  <p>Arrossega el botÃ³ a la barra de marcadors o prova fent clic (a la mateixa pÃ gina).</p>

  <div style="text-align:center;padding:20px;background:#fafafa;border-radius:8px;margin:1rem 0;">
    <a id="bookmarkletLink" class="bookmarklet" href="#">\uD83D\uDCC2 Docs Clickedu</a>
  </div>

  <textarea id="copyBox" rows="4" readonly></textarea>
  <button id="copyBtn">ðŸ“‹ Copia</button>
</div>

<script>
/* ---------- configuraciÃ³ ---------- */
const SHEET = "https://docs.google.com/spreadsheets/d/1iAF3p81G8DdByShDyfz4ShoweV80QWuoQ7wWSzZUORQ/export?format=csv&gid=0";
const PROXY = "https://cors.eu.org/";
const FINAL = PROXY + SHEET;

/* ---------- genera mapa colors (mateix codi) ---------- */
function genColors(groups){
  const map={};
  groups.forEach((g,i)=>{
    const hue = Math.floor((i/groups.length)*360);
    map[g] = { main: "hsl("+hue+",70%,50%)", hover: "hsl("+hue+",80%,40%)" };
  });
  return map;
}

/* ---------- construcciÃ³ del codi del bookmarklet COM A CADENA (segura) ---------- */
(async function build(){
  let colormap = {};
  try{
    const raw = await fetch(FINAL);
    const text = await raw.text();
    const lines = text.split("\n").slice(1);
    const groups = [...new Set(lines.filter(l=>l.trim()).map(l=>l.split(",")[0].trim()))];
    colormap = genColors(groups);
  }catch(e){
    colormap = { default:{ main:"hsl(210,70%,50%)", hover:"hsl(210,80%,40%)" } };
  }

  // IMPORTANT: no utilitzem backticks dins la cadena; escapa emojis amb \uXXXX
  const innerScript =
    "(function(){"+
      "if(!location.href.includes('insscf.clickedu.eu/sumari/index.php?p=links')){alert('\\u26A0\\uFE0F Aquest bookmarklet nomÃ©s funciona a la pÃ gina links.');return;}"+
      "const MAP="+JSON.stringify(colormap)+";"+
      "function txtColor(c){var m=c.match(/hsl\\((\\d+),\\s*(\\d+)%,\\s*(\\d+)%\\)/);return m&&(parseInt(m[3])>55)?'#000':'#fff';}"+
      "var f=document.evaluate('//form[@action=\\\"https://shorturl.at/anS1H\\\"]',document,null,9,null).singleNodeValue;var blk=f?f.closest('.bloc-info-sumari'):null;if(blk)blk.style.display='none';"+
      "var toggle=document.createElement('button');toggle.textContent='\\uD83D\\uDCC2 Mostrar documents';Object.assign(toggle.style,{position:'fixed',top:'10px',right:'10px',zIndex:99999,padding:'10px 15px',background:'#007bff',color:'#fff',border:'none',borderRadius:'8px',cursor:'pointer'});document.body.appendChild(toggle);"+
      "var overlay=null,open=false;toggle.onclick=function(){if(open){overlay.remove();overlay=null;open=false;return;}open=true;overlay=document.createElement('div');Object.assign(overlay.style,{position:'fixed',top:0,left:0,width:'100%',height:'100%',background:'rgba(0,0,0,0.85)',zIndex:99998,display:'flex',alignItems:'center',justifyContent:'center',padding:'20px',overflowY:'auto'});document.body.appendChild(overlay);"+
        "var loading=document.createElement('div');loading.textContent='\\u23F3 Carregant documents...';loading.style.color='white';loading.style.fontSize='20px';overlay.appendChild(loading);"+
        "fetch('"+FINAL+"').then(r=>{if(!r.ok)throw new Error('HTTP '+r.status);return r.text()}).then(t=>{var rows=t.split('\\n').slice(1);var docs=rows.filter(l=>l.trim()).map(l=>l.split(/,(?=(?:(?:[^\\\"]*\\\"){2})*[^\\\"]*$)/).map(v=>v.replace(/^\\\"|\\\"$/g,'').trim())).filter(p=>p.length>=3).map(p=>({g:p[0],l:p[1],u:p[2]}));loading.remove();var grid=document.createElement('div');Object.assign(grid.style,{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(250px,1fr))',gap:'15px',width:'90%',maxWidth:'1200px'});overlay.appendChild(grid);docs.forEach(function(d){var b=document.createElement('button');b.textContent=d.l;var c=MAP[d.g]||MAP.default;Object.assign(b.style,{padding:'15px',fontSize:'16px',borderRadius:'10px',border:'none',cursor:'pointer',background:c.main,color:txtColor(c.main)});b.onmouseover=function(){b.style.background=c.hover;b.style.color=txtColor(c.hover)};b.onmouseout=function(){b.style.background=c.main;b.style.color=txtColor(c.main)};b.onclick=function(){window.open(d.u,'_blank')};grid.appendChild(b)});}).catch(err=>{loading.textContent='\\u274C Error: '+err;loading.style.color='#ff6b6b';});"+
      "};"+
    "})();";

  // finalURI per enganxar al marcador (copiar/drag)
  const finalURI = "javascript:" + innerScript;
  document.getElementById("bookmarkletLink").href = finalURI;
  document.getElementById("copyBox").value = finalURI;

  /* ---------- AFEGIM UN CLICK-HANDLER PER PROVAR DIRECTAMENT A LA PÃ€GINA ---------- */
  const link = document.getElementById("bookmarkletLink");

  // 1) En provar fent clic dins la pÃ gina: executar directament el codi
  link.addEventListener("click", function(e){
    e.preventDefault();
    try{
      // Executa el codi directament en la pÃ gina (igual que el bookmarklet)
      (new Function(innerScript))();
    }catch(execErr){
      // si hi ha error mostrem a consola i alert (nomÃ©s per depurar)
      console.error("ExecuciÃ³ bookmarklet en pÃ gina: ", execErr);
      alert("Error executant el bookmarklet en la pÃ gina: "+execErr.message);
    }
  });

  // 2) Quan l'usuari arrossega el link a la barra de marcadors, quedarÃ  l'href (finalURI)
  //    Quan s'executi des del marcador en Clickedu farÃ  exactament el mateix.
})(); // build()
/* ---------- Copy button ---------- */
document.getElementById("copyBtn").addEventListener("click", function(){
  const ta = document.getElementById("copyBox");
  ta.select(); ta.setSelectionRange(0,99999);
  navigator.clipboard.writeText(ta.value).then(()=>{
    const btn = document.getElementById("copyBtn");
    btn.textContent = "âœ… Copiat!";
    btn.style.background = "#218838";
    setTimeout(()=>{btn.textContent="ðŸ“‹ Copia";btn.style.background="#28a745";},1800);
  }).catch(()=>{alert("No s'ha pogut copiar automÃ ticament. Selecciona i copia manualment.")});
});
</script>
</body>
</html>
