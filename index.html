<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Clickedu ‚Äì Bookmarklet corregit</title>
<style>
body { font-family: Arial, sans-serif; margin: 2rem; background: #f5f5f5; color: #333; line-height: 1.6; }
.container { max-width: 720px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.bookmarklet { display: inline-block; background: #ff6b35; color: #fff; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: bold; margin-top: 1rem; cursor: move; font-size: 16px; box-shadow: 0 2px 8px rgba(255,107,53,0.3); transition: all 0.2s; }
.bookmarklet:hover { background: #e55a28; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,107,53,0.4); }
#copyBox { width: 100%; padding: 0.8rem; font-size: 0.85rem; margin-top: 0.5rem; box-sizing: border-box; border: 2px solid #ddd; border-radius: 4px; font-family: monospace; background: #f9f9f9; }
#copyBtn { margin-top: 0.5rem; padding: 8px 16px; background: #28a745; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
#copyBtn:hover { background: #218838; }
.instruction { background: #e3f2fd; padding: 1rem; border-left: 4px solid #2196f3; margin: 1rem 0; border-radius: 4px; }
hr { margin: 2rem 0; border: none; border-top: 2px solid #eee; }
</style>
</head>
<body>
<div class="container">
<h1>üìÇ Clickedu ‚Äì Finestra de documents (versi√≥ corregida)</h1>

<div class="instruction">
<p><strong>1Ô∏è‚É£ Arrossega el bot√≥ taronja a la barra de marcadors</strong></p>
</div>

<div style="text-align:center; padding:20px; background:#fafafa; border-radius:8px; margin:1rem 0;">
<a class="bookmarklet" id="bookmarkletLink" href="#">üìÇ Docs Clickedu</a>
</div>

<div class="instruction">
<p><strong>2Ô∏è‚É£ Alternativa: Copia el codi</strong></p>
</div>

<textarea id="copyBox" rows="4" readonly></textarea>
<button id="copyBtn">üìã Copia</button>

</div>

<script>
const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/1iAF3p81G8DdByShDyfz4ShoweV80QWuoQ7wWSzZUORQ/export?format=csv&gid=0";
const PROXY_URL = "https://cors.eu.org/";
const FINAL_FETCH_URL = PROXY_URL + GOOGLE_SHEET_URL;

function generateGroupColors(groups) {
  const map = {};
  const total = groups.length;
  groups.forEach((g, i) => {
    const hue = Math.floor((i / total) * 360);
    map[g] = {
      main: `hsl(${hue},70%,50%)`,
      hover: `hsl(${hue},80%,40%)`
    };
  });
  return map;
}

(async function buildBookmarklet() {
  let fetchedColorMap = {};
  try {
    const resp = await fetch(FINAL_FETCH_URL);
    if (!resp.ok) throw new Error("Error carregant CSV");
    const csv = await resp.text();
    const lines = csv.split("\n").slice(1);

    const groups = Array.from(new Set(
      lines
        .filter(l => l.trim())
        .map(l => l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)[0].trim())
        .filter(g => g)
    ));

    fetchedColorMap = generateGroupColors(groups);
  } catch (e) {
    console.error(e);
    fetchedColorMap = { default: { main: "hsl(210,70%,50%)", hover: "hsl(210,80%,40%)" } };
  }

  const bookmarkletCode = `
    (async function(){
      if(!location.href.includes("insscf.clickedu.eu/sumari/index.php?p=links")){
        alert("‚ö†Ô∏è Aquest bookmarklet nom√©s funciona a la p√†gina 'links' de Clickedu.");
        return;
      }

      const COLOR_MAP = ${JSON.stringify(fetchedColorMap)};

      function getTextColor(bg){
        const m = bg.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
        if(!m) return "#fff";
        return (+m[3]) > 55 ? "#000" : "#fff";
      }

      const form = document.evaluate('//form[@action="https://shorturl.at/anS1H"]', document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
      const block = form?.closest('.bloc-info-sumari');
      if(block) block.style.display = 'none';

      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = 'üìÇ Mostrar documents';
      Object.assign(toggleBtn.style, {
        position: 'fixed', top: '10px', right: '10px', zIndex: 9999,
        padding: '10px 15px', background: '#007bff', color: '#fff',
        border: 'none', borderRadius: '8px', cursor: 'pointer'
      });
      document.body.appendChild(toggleBtn);

      let open = false;
      let overlay = null;

      toggleBtn.onclick = async () => {
        if(open){ overlay.remove(); open=false; return; }
        open = true;

        overlay = document.createElement('div');
        Object.assign(overlay.style, {
          position:'fixed', top:0, left:0, width:'100%', height:'100%',
          background:'rgba(0,0,0,0.8)', zIndex:9998, display:'flex',
          flexDirection:'column', alignItems:'center', justifyContent:'center',
          overflowY:'auto', padding:'20px'
        });
        document.body.appendChild(overlay);

        const loading = document.createElement('div');
        loading.textContent = '‚è≥ Carregant documents...';
        loading.style.color = 'white';
        loading.style.fontSize = '20px';
        overlay.appendChild(loading);

        try{
          const r = await fetch('${FINAL_FETCH_URL}');
          if(!r.ok) throw new Error('Error de c√†rrega');
          const text = await r.text();
          const rows = text.split('\n').slice(1);

          const docs = rows
            .filter(l => l.trim())
            .map(l => l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim()))
            .filter(p => p.length >= 3)
            .map(p => ({ g:p[0], l:p[1], u:p[2] }));

          loading.remove();

          const grid = document.createElement('div');
          Object.assign(grid.style, {
            display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(250px, 1fr))',
            gap:'15px', width:'90%', maxWidth:'1200px'
          });

          docs.forEach(d => {
            const docBtn = document.createElement('button');
            docBtn.textContent = d.l;
            const col = COLOR_MAP[d.g] || COLOR_MAP.default;
            Object.assign(docBtn.style, {
              padding:'15px', fontSize:'16px', borderRadius:'10px',
              border:'none', cursor:'pointer', background:col.main,
              color:getTextColor(col.main)
            });
            docBtn.onmouseover = () => { docBtn.style.background = col.hover; docBtn.style.color = getTextColor(col.hover);} ;
            docBtn.onmouseout  = () => { docBtn.style.background = col.main;  docBtn.style.color = getTextColor(col.main);} ;
            docBtn.onclick = () => window.open(d.u, '_blank');
            grid.appendChild(docBtn);
          });

          overlay.appendChild(grid);
        } catch(err) {
          loading.textContent = '‚ùå Error carregant documents: ' + err.message;
          loading.style.color = '#ff6b6b';
        }
      };
    })();
  `;

  const finalURI = "javascript:" + encodeURI(bookmarkletCode);

  document.getElementById("bookmarkletLink").href = finalURI;
  document.getElementById("copyBox").value = finalURI;
})();

// Copy button
const btn = document.getElementById("copyBtn");
btn.onclick = () => {
  const ta = document.getElementById("copyBox");
  ta.select(); ta.setSelectionRange(0,99999);
  navigator.clipboard.writeText(ta.value).then(() => {
    btn.textContent = "‚úÖ Copiat!";
    btn.style.background = "#218838";
    setTimeout(()=>{
      btn.textContent = "üìã Copia";
      btn.style.background = "#28a745";
    },2000);
  });
};
</script>
</body>
</html>
