<!DOCTYPE html>
<html lang="ca">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Clickedu â€“ bookmarklet per la finestra de Documents</title>
Â  <style>
Â  Â  body {
Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  margin: 2rem;
Â  Â  Â  background: #f5f5f5;
Â  Â  Â  color: #333;
Â  Â  Â  line-height: 1.6;
Â  Â  }
Â  Â  .container {
Â  Â  Â  max-width: 720px;
Â  Â  Â  margin: auto;
Â  Â  Â  background: white;
Â  Â  Â  padding: 2rem;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .bookmarklet {
Â  Â  Â  display: inline-block;
Â  Â  Â  background: #ff6b35;
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 12px 24px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  text-decoration: none;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin-top: 1rem;
Â  Â  Â  cursor: move;
Â  Â  Â  font-size: 16px;
Â  Â  Â  box-shadow: 0 2px 8px rgba(255,107,53,0.3);
Â  Â  Â  transition: all 0.2s;
Â  Â  }
Â  Â  .bookmarklet:hover {
Â  Â  Â  background: #e55a28;
Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  box-shadow: 0 4px 12px rgba(255,107,53,0.4);
Â  Â  }
Â  Â  #copyBox {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 0.8rem;
Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  margin-top: 0.5rem;
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  border: 2px solid #ddd;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  font-family: monospace;
Â  Â  Â  background: #f9f9f9;
Â  Â  }
Â  Â  #copyBtn {
Â  Â  Â  margin-top: 0.5rem;
Â  Â  Â  padding: 8px 16px;
Â  Â  Â  background: #28a745;
Â  Â  Â  color: #fff;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: bold;
Â  Â  Â  transition: background 0.2s;
Â  Â  }
Â  Â  #copyBtn:hover {
Â  Â  Â  background: #218838;
Â  Â  }
Â  Â  .instruction {
Â  Â  Â  background: #e3f2fd;
Â  Â  Â  padding: 1rem;
Â  Â  Â  border-left: 4px solid #2196f3;
Â  Â  Â  margin: 1rem 0;
Â  Â  Â  border-radius: 4px;
Â  Â  }
Â  Â  hr {
Â  Â  Â  margin: 2rem 0;
Â  Â  Â  border: none;
Â  Â  Â  border-top: 2px solid #eee;
Â  Â  }
Â  </style>
</head>
<body>
<div class="container">
Â  <h1>ğŸ“‚ Clickedu â€“ Finestra de documents</h1>

Â  <div class="instruction">
Â  Â  <p><strong>1ï¸âƒ£ Arrossega el botÃ³ taronja de sota a la barra de marcadors del teu navegador</strong></p>
Â  Â  <p>AixÃ² desa un bookmarklet que s'executarÃ  a Clickedu per mostrar els teus documents en una finestra molt prÃ ctica.</p>
Â  </div>

Â  <div style="text-align: center; padding: 20px; background: #fafafa; border-radius: 8px; margin: 1rem 0;">
Â  Â  <a class="bookmarklet" id="bookmarkletLink" href="#">
Â  Â  Â  ğŸ“‚ Docs Clickedu
Â  Â  </a>
Â  Â  <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
Â  Â  Â  â¬†ï¸ Arrossega aquest botÃ³ a la barra de marcadors
Â  Â  </p>
Â  </div>

Â  <div class="instruction">
Â  Â  <p><strong>2ï¸âƒ£ Alternativa: Copia al porta-retalls</strong></p>
Â  Â  <p>Si arrossegar no funciona (mÃ²bil o restriccions del navegador), fes clic al botÃ³ Copia de sota, desprÃ©s crea un marcador nou manualment i enganxa l'URL.</p>
Â  </div>

Â  <textarea id="copyBox" rows="4" readonly></textarea>
Â  <button id="copyBtn">ğŸ“‹ Copia al porta-retalls</button>

Â  <hr>
Â Â 
Â  <p style="font-size: 0.9rem; color: #666;">
Â  Â  <strong>â„¹ï¸ Com funciona:</strong> Aquesta versiÃ³ carrega la llista de documents automÃ ticament des del Full de CÃ lcul de Google utilitzant un servidor intermediari per evitar els errors de seguretat CORS.
Â  </p>
</div>

<script>
// IMPORTANT: Use the /export URL format, and ensure your sheet is published to the web!
const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1iAF3p81G8DdByShDyfz4ShoweV80QWuoQ7wWSzZUORQ/export?format=csv&gid=0';

// This CORS proxy is added to allow the fetch request to succeed from any origin.
const PROXY_URL = 'https://cors-anywhere.herokuapp.com/'; 
const FINAL_FETCH_URL = PROXY_URL + GOOGLE_SHEET_URL;

// The bookmarklet code that fetches from Google Sheets via the proxy
const bookmarkletCode = `javascript:(async function(){
    if(!location.href.includes('insscf.clickedu.eu/sumari/index.php?p=links')){
        alert('âš ï¸ Aquest bookmarklet nomÃ©s funciona a la pÃ gina "links" de Clickedu.');
        return;
    }
    
    // UI Cleanup (Hiding the existing form)
    let formNode=null,containerNode=null;
    const formXPath='//form[@action="https://shorturl.at/anS1H"]';
    formNode=document.evaluate(formXPath,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;
    if(formNode){
        containerNode=formNode.closest('.bloc-info-sumari');
        if(containerNode){
            containerNode.style.display='none';
        }else{
            formNode.style.display='none';
        }
    }
    
    // Floating Button Setup
    const btn=document.createElement('button');
    btn.textContent='ğŸ“‚ Mostrar documents';
    Object.assign(btn.style,{position:'fixed',top:'10px',right:'10px',zIndex:9999,padding:'10px 15px',background:'#007bff',color:'#fff',border:'none',borderRadius:'8px',cursor:'pointer',boxShadow:'0 2px 4px rgba(0,0,0,.2)',transition:'background .2s,opacity .3s',fontWeight:'bold',opacity:'1'});
    btn.onmouseover=function(){btn.style.background='#0056b3'};
    btn.onmouseout=function(){btn.style.background='#007bff'};
    document.body.appendChild(btn);

    let overlayVisible=!1;
    btn.onclick=async function(){
        // Hide existing element
        if(containerNode){containerNode.style.display='none'}else if(formNode){formNode.style.display='none'};
        
        // Toggle overlay
        if(overlayVisible){closeOverlay();btn.style.opacity='1';return;}
        overlayVisible=!0;
        btn.style.opacity='0.2';
        
        // Overlay and Loading Message
        const overlay=document.createElement('div');
        Object.assign(overlay.style,{position:'fixed',top:0,left:0,width:'100%',height:'100%',background:'rgba(0,0,0,0.8)',zIndex:9998,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:'20px',overflowY:'auto'});
        overlay.addEventListener('click',e=>{e.target===overlay&&closeOverlay()});
        
        document.addEventListener('keydown',esc);
        function esc(e){e.key==='Escape'&&closeOverlay()}
        function closeOverlay(){overlay.remove();document.removeEventListener('keydown',esc);overlayVisible=!1;btn.style.opacity='1'}
        
        const loadingMsg=document.createElement('div');
        loadingMsg.textContent='â³ Carregant documents (via proxy)...';
        Object.assign(loadingMsg.style,{color:'white',fontSize:'18px',marginBottom:'20px'});
        overlay.appendChild(loadingMsg);
        document.body.appendChild(overlay);

        try{
            // The key change: Fetching the Google Sheets CSV via the CORS proxy
            const csvUrl='${FINAL_FETCH_URL}';
            const response=await fetch(csvUrl);
            if(!response.ok) throw new Error('CÃ rrega fallida. Codi: '+response.status);
            
            const csvText=await response.text();
            
            // CSV Parsing Logic (assuming Link Name in column A and URL in column B)
            const lines=csvText.split('\\n').slice(1);
            const docs=lines.filter(line=>line.trim()).map(line=>{
                // Robust parsing for quoted fields
                const match=line.match(/^"?([^",]+)"?,+"?([^"]+)"?$/);
                if(match){
                    return{l:match[1].trim(),u:match[2].trim()}
                }
                // Fallback parsing for simple CSV
                const parts=line.split(',');
                return{l:parts[0]?.replace(/^"+|"+$/g,'').trim(),u:parts[1]?.replace(/^"+|"+$/g,'').trim()}
            }).filter(doc=>doc.l&&doc.u); // Filter out empty/invalid rows

            loadingMsg.remove();
            
            if(docs.length===0){
                loadingMsg.textContent='âš ï¸ No s\\'han trobat documents vÃ lids al full de cÃ lcul.';
                loadingMsg.style.color='#ffc107';
                overlay.appendChild(loadingMsg);
                return;
            }

            // Document Grid Rendering
            const grid=document.createElement('div');
            Object.assign(grid.style,{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(280px,1fr))',gap:'15px',maxWidth:'1200px',width:'100%'});
            
            docs.forEach(o=>{
                const b=document.createElement('button');
                b.textContent=o.l;
                Object.assign(b.style,{padding:'15px',fontSize:'16px',cursor:'pointer',borderRadius:'12px',border:'none',background:'#007bff',color:'#fff',boxShadow:'0 4px 6px rgba(0,0,0,0.2)',transition:'background .2s'});
                b.onmouseover=function(){b.style.background='#0056b3'};
                b.onmouseout=function(){b.style.background='#007bff'};
                b.onclick=function(){window.open(o.u,'_blank')}; // Opens link in new tab
                grid.appendChild(b);
            });
            overlay.appendChild(grid);

        }catch(err){
            loadingMsg.textContent='âŒ Error crÃ­tic: No s\\'ha pogut carregar la llista. Assegureu-vos que el full de cÃ lcul estigui publicat correctament. Detall: '+err.message;
            loadingMsg.style.color:'#ff6b6b';
        }
    };
})();`;

// Set the href using JavaScript
document.getElementById('bookmarkletLink').href = bookmarkletCode;

// Set the textarea content
document.getElementById('copyBox').value = bookmarkletCode;

// Copy to clipboard functionality (omitted for brevity, assume it's the same)
document.getElementById('copyBtn').addEventListener('click', function() {
    const ta = document.getElementById('copyBox');
    ta.select();
    ta.setSelectionRange(0, 99999);
    
    navigator.clipboard.writeText(ta.value).then(() => {
        const btn = document.getElementById('copyBtn');
        btn.textContent = 'âœ… Copiat!';
        btn.style.background = '#218838';
        setTimeout(() => {
            btn.textContent = 'ğŸ“‹ Copia al porta-retalls';
            btn.style.background = '#28a745';
        }, 2000);
    }).catch(() => {
        document.execCommand('copy');
        alert('Bookmarklet copiat! Ara crea un marcador nou i enganxa\'l.');
    });
});
</script>
</body>
</html>
